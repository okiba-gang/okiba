# Use the latest stable version of Semaphore 2.0 YML syntax:
version: v1.0

name: Testing

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Install dependencies
    task:
      env_vars:
        - name: NODE_ENV
          value: test
        - name: CI
          value: 'true'

      prologue:
        commands:
          - checkout
          - nvm use 10
      jobs:
        - name: npm install and cache
          commands:
            - cache restore node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json)
            - npm install
            - cache store node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json) node_modules
            
  - name: Test
    task:
      secrets:
        - name: okiba-code-climate
      env_vars:
        - name: NODE_ENV
          value: test
        - name: CI
          value: 'true'
      prologue:
        commands:
          - checkout
          - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
          - chmod +x ./cc-test-reporter
          - ./cc-test-reporter before-build
          - nvm use 10
          - node --version
          - npm --version
      jobs:
        - name: Jest
          commands:
            - cache restore node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json)
            - npm test
            - ls -la
            - ./cc-test-reporter after-build -t lcov --debug --exit-code $?
